<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Transmisión P2P cámara + audio - link con señal</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    margin: 0;
    padding: 1em;
  }
  video {
    max-width: 90vw;
    max-height: 70vh;
    background: black;
    border: 2px solid #44ff44;
  }
  button {
    font-size: 1.2em;
    margin: 0.5em;
    padding: 0.5em 1em;
    background: #44ff44;
    color: #111;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #signalLink {
    display: block;
    margin-top: 1em;
    padding: 0.5em;
    background: #222;
    color: #4aff4a;
    border: 2px solid #44ff44;
    word-break: break-all;
    user-select: all;
  }
</style>
</head>
<body>
<h1>Transmisión P2P cámara + audio</h1>
<video id="video" autoplay playsinline></video><br/>
<button id="startBtn">Iniciar transmisión</button>
<button id="connectBtn" disabled>Conectar a transmisión</button><br/>
<a id="signalLink" href="#" target="_blank" title="Link para compartir la señal SDP"></a>

<script>
(async () => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const connectBtn = document.getElementById('connectBtn');
  const signalLink = document.getElementById('signalLink');

  let localStream;
  let pc;

  const configuration = {
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  };

  // Codificar y decodificar base64 URL safe
  function encodeSignal(signal) {
    return btoa(unescape(encodeURIComponent(signal)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }
  function decodeSignal(encoded) {
    encoded = encoded.replace(/-/g, '+').replace(/_/g, '/');
    while (encoded.length % 4) encoded += '=';
    return decodeURIComponent(escape(atob(encoded)));
  }

  function createPeerConnection() {
    pc = new RTCPeerConnection(configuration);

    pc.onicecandidate = event => {
      if (event.candidate) return;
      const localDesc = JSON.stringify(pc.localDescription);
      const encoded = encodeSignal(localDesc);
      const url = `${window.location.origin}${window.location.pathname}?signal=${encoded}`;
      signalLink.href = url;
      signalLink.textContent = url;
      connectBtn.disabled = false;
    };

    pc.ontrack = event => {
      video.srcObject = event.streams[0];
    };
  }

  startBtn.onclick = async () => {
    startBtn.disabled = true;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      video.srcObject = localStream;

      createPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    } catch (e) {
      alert('Error accediendo a cámara/micrófono o creando conexión:\n' + e);
      startBtn.disabled = false;
    }
  };

  connectBtn.onclick = async () => {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      let remoteDescStr = urlParams.get('signal');

      if (!remoteDescStr) {
        remoteDescStr = prompt('Pega aquí la señal SDP del emisor:');
        if (!remoteDescStr) return alert('Señal vacía');
        remoteDescStr = decodeSignal(remoteDescStr);
      } else {
        remoteDescStr = decodeSignal(remoteDescStr);
      }

      createPeerConnection();
      const remoteDesc = new RTCSessionDescription(JSON.parse(remoteDescStr));
      await pc.setRemoteDescription(remoteDesc);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      alert('Transmisión conectada. Ahora debes enviar esta respuesta al emisor para completar la conexión.');

    } catch (e) {
      alert('Error conectando a la transmisión:\n' + e);
    }
  };

  // Al cargar la página, si hay señal en URL, habilitamos el botón conectar
  window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('signal')) {
      connectBtn.disabled = false;
    }
  };

  connectBtn.disabled = true;
})();
</script>
</body>
</html>
