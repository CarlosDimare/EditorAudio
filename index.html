<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Transmisión P2P cámara + audio - señal simplificada</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    margin: 0;
    padding: 1em;
  }
  video {
    max-width: 90vw;
    max-height: 70vh;
    background: black;
    border: 2px solid #44ff44;
  }
  button {
    font-size: 1.2em;
    margin: 0.5em;
    padding: 0.5em 1em;
    background: #44ff44;
    color: #111;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #signal {
    width: 90vw;
    height: 100px;
    margin-top: 1em;
    background: #222;
    color: #4aff4a;
    border: 2px solid #44ff44;
    padding: 0.5em;
    font-family: monospace;
    overflow-wrap: break-word;
    resize: none;
  }
</style>
</head>
<body>
<h1>Transmisión P2P cámara + audio</h1>
<video id="video" autoplay playsinline></video><br/>
<button id="startBtn">Iniciar transmisión</button>
<button id="connectBtn" disabled>Conectar a transmisión</button><br/>
<textarea id="signal" readonly placeholder="Aquí aparecerá la señal SDP..."></textarea><br/>
<button id="copyBtn" disabled>Copiar señal</button>

<script>
(async () => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const connectBtn = document.getElementById('connectBtn');
  const signalTextarea = document.getElementById('signal');
  const copyBtn = document.getElementById('copyBtn');

  let localStream;
  let pc;
  let isCaller = false;

  const configuration = {
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  };

  function createPeerConnection() {
    pc = new RTCPeerConnection(configuration);

    pc.onicecandidate = event => {
      if (event.candidate) return;
      const localDesc = JSON.stringify(pc.localDescription);
      signalTextarea.value = localDesc;
      copyBtn.disabled = false;
    };

    pc.ontrack = event => {
      video.srcObject = event.streams[0];
    };
  }

  startBtn.onclick = async () => {
    startBtn.disabled = true;
    isCaller = true;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      video.srcObject = localStream;

      createPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    } catch (e) {
      alert('Error accediendo a cámara/micrófono o creando conexión:\n' + e);
      startBtn.disabled = false;
    }
  };

  connectBtn.onclick = async () => {
    try {
      const remoteDescStr = prompt('Pega aquí la señal SDP del emisor:');
      if (!remoteDescStr) return alert('Señal vacía');

      createPeerConnection();
      const remoteDesc = new RTCSessionDescription(JSON.parse(remoteDescStr));
      await pc.setRemoteDescription(remoteDesc);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      signalTextarea.value = JSON.stringify(pc.localDescription);
      copyBtn.disabled = false;

      pc.onicecandidate = event => {
        if (event.candidate) return;
        alert('Copiá esta señal y envíasela al emisor:\n' + JSON.stringify(pc.localDescription));
      };
    } catch (e) {
      alert('Error conectando a la transmisión:\n' + e);
    }
  };

  signalTextarea.addEventListener('focus', () => {
    signalTextarea.select();
  });

  copyBtn.onclick = () => {
    signalTextarea.select();
    document.execCommand('copy');
    alert('Señal copiada al portapapeles');
  };

  const observer = new MutationObserver(() => {
    if (signalTextarea.value.length > 100) connectBtn.disabled = false;
  });
  observer.observe(signalTextarea, { characterData: true, subtree: true, childList: true });

})();
</script>
</body>
</html>
